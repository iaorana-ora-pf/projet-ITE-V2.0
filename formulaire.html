<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soumettre un événement</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1em; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, textarea { width: 100%; padding: 0.5em; }
    button { margin-top: 1em; padding: 0.7em 1.5em; }
  </style>
</head>
<body>

  <h1>Soumettre un événement</h1>
  <form id="event-form">
    <label>Titre *</label>
    <input type="text" name="title" required>

    <label>Année *</label>
    <input type="number" name="year" required>

    <label>Description</label>
    <textarea name="description"></textarea>

    <label>Catégories (séparées par virgules)</label>
    <input type="text" name="categories">

    <label>Mots-clés (séparés par virgules)</label>
    <input type="text" name="keywords">

    <label>Sources (format : Label | URL, séparées par virgules)</label>
    <input type="text" name="sources">

    <label>Pour aller plus loin</label>
    <textarea name="more"></textarea>

    <label>Contributeur *</label>
    <input type="text" name="contributeur" required>

    <button type="submit">Envoyer</button>
  </form>

  <script>
    const form = document.getElementById('event-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = Object.fromEntries(new FormData(form).entries());

      // Champs techniques automatiques
      const now = new Date();
      data.id = `evt-${now.toISOString().replace(/[-:.TZ]/g, '').slice(0, 14)}`;
      data.slug = data.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '-');
      data.added = now.toISOString().split('T')[0];
      data.validated = false;

      // Nettoyage
      data.categories = data.categories ? data.categories.split(',').map(c => c.trim()) : [];
      data.keywords = data.keywords ? data.keywords.split(',').map(k => k.trim()) : [];
      data.sources = data.sources ? data.sources.split(',').map(s => {
        const [label, url] = s.split('|').map(x => x.trim());
        return { label, url };
      }) : [];

      try {
        await fetch('https://script.google.com/macros/s/AKfycbw5TjQ6TIIHA9fMDFKHSrMBYGmViLXMK2lh4bSI8F214UbuN0rZ6DBfYq91GFXrFU07/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        alert("Merci ! Votre proposition a bien été envoyée.");
        form.reset();
      } catch (err) {
        alert("Erreur : impossible d’envoyer les données.");
        console.error(err);
      }
    });
  </script>

</body>
</html>
